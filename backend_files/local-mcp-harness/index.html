<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Polymarket MCP Harness</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f7fb;
      color: #1f2933;
    }

    h1 {
      margin-top: 0;
    }

    .card {
      background: #fff;
      border: 1px solid #d8dee6;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }

    label {
      display: block;
      font-weight: 600;
      margin-top: 8px;
    }

    input,
    select,
    textarea,
    button {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #c7d0dc;
      font-size: 14px;
    }

    button {
      background: #2563eb;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    button.secondary {
      background: #fff;
      color: #2563eb;
      border: 1px solid #2563eb;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .small {
      font-size: 12px;
      color: #4b5563;
    }

    pre {
      background: #0b1021;
      color: #e5e7eb;
      padding: 12px;
      border-radius: 6px;
      overflow: auto;
      max-height: 320px;
    }

    .flex {
      display: flex;
      gap: 8px;
    }

    .flex button {
      width: auto;
    }
  </style>
</head>

<body>
  <h1>Polymarket MCP Local Harness</h1>
  <p class="small">Local-only tester. Provide Firebase config, sign in, issue an MCP token, discover tools, and run
    calls.</p>

  <div class="card" id="config-card">
    <h2>Setup</h2>
    <div class="row">
      <div>
        <label>Functions Base URL</label>
        <input id="base-url" value="https://us-central1-audit-3a7ec.cloudfunctions.net" />
      </div>
      <div>
        <label>Scopes (comma-separated)</label>
        <input id="scopes" value="polymarket:read:public,polymarket:read:user,polymarket:read:stream" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Firebase apiKey</label>
        <input id="fb-api-key" value="AIzaSyBMek_GPELnpRZ44As_DEZWHJQOnxgcGb0" />
      </div>
      <div>
        <label>Firebase authDomain</label>
        <input id="fb-auth-domain" value="audit-3a7ec.firebaseapp.com" />
      </div>
      <div>
        <label>Firebase projectId</label>
        <input id="fb-project-id" value="audit-3a7ec" />
      </div>
      <div>
        <label>Firebase appId</label>
        <input id="fb-app-id" value="1:734175123527:web:226b4fc4cfdefa686bf962" />
      </div>
    </div>
  </div>

  <div class="card" id="auth-card">
    <h2>Login</h2>
    <div class="row">
      <div>
        <label>Email</label>
        <input id="email" type="email" placeholder="you@example.com" />
      </div>
      <div>
        <label>Password</label>
        <input id="password" type="password" />
      </div>
    </div>
    <div class="flex" style="margin-top:12px;">
      <button id="login-btn">Sign in (email/password)</button>
      <button id="google-btn" class="secondary">Sign in with Google</button>
      <button id="logout-btn" class="secondary">Sign out</button>
    </div>
    <p class="small" id="auth-status">Not signed in.</p>
    <div class="flex" style="margin-top:8px;">
      <button id="issue-token-btn" disabled>Issue MCP token</button>
      <button id="fetch-tools-btn" class="secondary" disabled>Fetch tools</button>
    </div>
    <p class="small" id="token-status">No MCP token yet.</p>
  </div>

  <div class="card" id="tool-card">
    <h2>Run tool</h2>
    <div class="row">
      <div>
        <label>Tool</label>
        <select id="tool-select"></select>
      </div>
    </div>
    <label style="margin-top:12px;">Input JSON (token auto-injected if missing)</label>
    <textarea id="tool-input" rows="8">{}</textarea>
    <button id="run-tool-btn" style="margin-top:12px;" disabled>Run</button>
  </div>

  <div class="card">
    <h2>Result</h2>
    <pre id="result-area">Waiting...</pre>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      getIdToken,
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithPopup,
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

    let auth;
    let mcpToken;
    let claims;

    const els = {
      baseUrl: document.getElementById("base-url"),
      scopes: document.getElementById("scopes"),
      apiKey: document.getElementById("fb-api-key"),
      authDomain: document.getElementById("fb-auth-domain"),
      projectId: document.getElementById("fb-project-id"),
      appId: document.getElementById("fb-app-id"),
      email: document.getElementById("email"),
      password: document.getElementById("password"),
      loginBtn: document.getElementById("login-btn"),
      googleBtn: document.getElementById("google-btn"),
      logoutBtn: document.getElementById("logout-btn"),
      authStatus: document.getElementById("auth-status"),
      tokenStatus: document.getElementById("token-status"),
      issueTokenBtn: document.getElementById("issue-token-btn"),
      fetchToolsBtn: document.getElementById("fetch-tools-btn"),
      toolSelect: document.getElementById("tool-select"),
      toolInput: document.getElementById("tool-input"),
      runToolBtn: document.getElementById("run-tool-btn"),
      resultArea: document.getElementById("result-area"),
    };

    function logResult(data) {
      els.resultArea.textContent = typeof data === "string" ? data : JSON.stringify(data, null, 2);
    }

    function clientLog(event, payload) {
      const body = JSON.stringify({ event, payload, ts: Date.now() });
      if (navigator.sendBeacon) {
        const blob = new Blob([body], { type: "application/json" });
        navigator.sendBeacon("/client-log", blob);
      } else {
        fetch("/client-log", { method: "POST", headers: { "Content-Type": "application/json" }, body }).catch(() => { });
      }
    }

    async function readResponse(resp) {
      try {
        return await resp.clone().json();
      } catch {
        try {
          return await resp.clone().text();
        } catch {
          return null;
        }
      }
    }

    function ensureApp() {
      const config = {
        apiKey: els.apiKey.value.trim(),
        authDomain: els.authDomain.value.trim(),
        projectId: els.projectId.value.trim(),
        appId: els.appId.value.trim(),
      };
      if (!config.apiKey || !config.authDomain || !config.projectId || !config.appId) {
        throw new Error("Firebase config is required");
      }
      if (!getApps().length) {
        initializeApp(config);
      }
      auth = getAuth();
      onAuthStateChanged(auth, (user) => {
        if (user) {
          els.authStatus.textContent = `Signed in as ${user.email}`;
          els.issueTokenBtn.disabled = false;
          els.fetchToolsBtn.disabled = false;
          els.runToolBtn.disabled = false;
        } else {
          els.authStatus.textContent = "Not signed in.";
          els.issueTokenBtn.disabled = true;
          els.fetchToolsBtn.disabled = true;
          els.runToolBtn.disabled = true;
          mcpToken = undefined;
          claims = undefined;
          els.tokenStatus.textContent = "No MCP token yet.";
        }
      });
    }

    // Initialize early to set up auth listener
    try {
      ensureApp();
    } catch (err) {
      logResult({ error: err.message || String(err) });
    }

    els.loginBtn.addEventListener("click", async () => {
      try {
        ensureApp();
        const email = els.email.value.trim();
        const password = els.password.value;
        if (!email || !password) throw new Error("Email and password are required");
        await signInWithEmailAndPassword(auth, email, password);
        els.authStatus.textContent = "Signed in";
      } catch (err) {
        logResult({ error: err.message || String(err) });
      }
    });

    els.googleBtn.addEventListener("click", async () => {
      try {
        ensureApp();
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      } catch (err) {
        logResult({ error: err.message || String(err) });
      }
    });

    els.logoutBtn.addEventListener("click", async () => {
      try {
        if (!auth) return;
        await signOut(auth);
        els.authStatus.textContent = "Not signed in.";
        mcpToken = undefined;
        claims = undefined;
        els.tokenStatus.textContent = "No MCP token yet.";
      } catch (err) {
        logResult({ error: err.message || String(err) });
      }
    });

    els.issueTokenBtn.addEventListener("click", async () => {
      try {
        ensureApp();
        els.issueTokenBtn.disabled = true;
        els.tokenStatus.textContent = "Issuing MCP token...";
        const user = auth.currentUser;
        if (!user) throw new Error("Sign in first");
        const idToken = await getIdToken(user, true);
        const scopes = els.scopes.value
          .split(",")
          .map((s) => s.trim())
          .filter(Boolean);
        const baseUrl = els.baseUrl.value.trim().replace(/\/$/, "");
        if (!baseUrl) throw new Error("Base URL is required");
        console.log("Issuing MCP token", { baseUrl, scopes });
        clientLog("issueMcpToken:start", { baseUrl, scopes });
        const resp = await fetch(`${baseUrl}/issueMcpToken`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ idToken, scopes }),
        });
        const body = await readResponse(resp);
        console.log("issueMcpToken response", { status: resp.status, body });
        clientLog("issueMcpToken:response", { status: resp.status, body });
        if (!resp.ok) throw new Error((body && body.error) || `issueMcpToken failed (${resp.status})`);
        mcpToken = body.token;
        claims = body.claims;
        els.tokenStatus.textContent = `MCP token issued (scopes: ${claims.scopes?.join(", ") || "none"})`;
        logResult({ claims, status: resp.status });
      } catch (err) {
        logResult({ error: err.message || String(err) });
        els.tokenStatus.textContent = "Failed to issue MCP token.";
        console.error(err);
        clientLog("issueMcpToken:error", { message: err.message, stack: err.stack });
      } finally {
        els.issueTokenBtn.disabled = false;
      }
    });

    els.fetchToolsBtn.addEventListener("click", async () => {
      try {
        const baseUrl = els.baseUrl.value.trim().replace(/\/$/, "");
        if (!baseUrl) throw new Error("Base URL is required");
        const resp = await fetch(`${baseUrl}/polymarketReadMcp`, { method: "GET" });
        const body = await resp.json();
        if (!resp.ok) throw new Error(body?.error || `Discovery failed (${resp.status})`);
        els.toolSelect.innerHTML = "";
        (body.tools || []).forEach((tool) => {
          const opt = document.createElement("option");
          opt.value = tool.name;
          opt.textContent = `${tool.name} â€“ ${tool.description || ""}`;
          els.toolSelect.appendChild(opt);
        });
        logResult(body);
      } catch (err) {
        logResult({ error: err.message || String(err) });
      }
    });

    els.runToolBtn.addEventListener("click", async () => {
      try {
        if (!mcpToken) throw new Error("Issue an MCP token first");
        const tool = els.toolSelect.value;
        if (!tool) throw new Error("Select a tool");
        let userInput = {};
        const raw = els.toolInput.value.trim();
        if (raw) {
          userInput = JSON.parse(raw);
        }

        const baseUrl = els.baseUrl.value.trim().replace(/\/$/, "");
        const resp = await fetch(`${baseUrl}/polymarketReadMcp`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${mcpToken}`
          },
          body: JSON.stringify({ tool, input: userInput }),
        });
        const body = await resp.json();
        if (!resp.ok) throw new Error(body?.error || `MCP error (${resp.status})`);
        logResult(body);
      } catch (err) {
        logResult({ error: err.message || String(err) });
      }
    });

    // Defaults already applied above
  </script>
</body>

</html>